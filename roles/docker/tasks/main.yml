---
- apt_key:
    id: 58118E89F3A912897C070ADBF76221572C52609D
    state: absent

- apt_repository:
    repo: deb https://apt.dockerproject.org/repo ubuntu-xenial main
    filename: docker
    state: absent
    update_cache: yes

- apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    id: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88

- apt_repository:
    repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
    filename: docker
    update_cache: yes

- file: dest=/etc/systemd/system/docker.service.d state=directory

- copy:
    content: |
      #!/bin/sh
      echo "All runlevel operations denied by policy" >&2
      exit 101
    dest: /usr/sbin/policy-rc.d
    mode: 0755
  changed_when: no

- apt: name={{ item }}
  with_items:
    - docker-ce
    - dmsetup
    - python-docker
    - systemd-docker
  register: packages

- file: path=/usr/sbin/policy-rc.d state=absent
  changed_when: no

- command: dmsetup mknodes
  when: packages.changed

- template: dest=/etc/systemd/system/docker.service.d/override.conf src=docker.service.j2
  notify:
    - reload systemd
    - restart docker

- service: name=docker state=started enabled=yes

- docker_network:
    name: wordpress
    driver_options:
      com.docker.network.bridge.name: docker1
    ipam_options:
      subnet: 172.18.0.0/16

- include_vars: file=../../../../users.yml name=users

- user:
    name: "{{ item }}"
    groups: docker
    append: yes
  with_items: "{{ users.keys() }}"

- copy: src=docker-update.sh dest=/etc/cron.daily/docker-update mode=0755
